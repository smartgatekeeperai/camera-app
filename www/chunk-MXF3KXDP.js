import{$ as J,C as M,D as u,E as x,F as B,J as $,K as X,L as D,Oa as t1,P as L,Pa as i1,Q as H,Qa as n1,R as V,Ra as l1,S as z,Sa as e1,T as Y,Ta as c1,U as F,Ua as r1,Z,Za as v1,ca as K,d as S,da as k,g as j,ga as o1,k as W,l as Q,na as a1,s as p,sa as s1,t as O,v as G,z as q}from"./chunk-FXLA5C26.js";import"./chunk-N6LJKXTK.js";import{a as g1,b as h1}from"./chunk-TCIP6WF6.js";import"./chunk-BNBRWPES.js";import"./chunk-ISHI2HGM.js";import"./chunk-NR7J2KNO.js";import"./chunk-O6KY7EYP.js";import"./chunk-XF2MK4EZ.js";import"./chunk-4WFVMWDK.js";import"./chunk-M2X7KQLB.js";import"./chunk-2YSZFPCQ.js";import"./chunk-57YRIO75.js";import"./chunk-FNBMHXHF.js";import"./chunk-C5RQ2IC2.js";import"./chunk-42C7ZIID.js";import{h as y}from"./chunk-B7O3QC5Z.js";var I,f1=function(){if(typeof window>"u")return new Map;if(!I){var t=window;t.Ionicons=t.Ionicons||{},I=t.Ionicons.map=t.Ionicons.map||new Map}return I},R=function(t){Object.keys(t).forEach(function(w){w1(w,t[w]);var a=w.replace(/([a-z0-9]|(?=[A-Z]))([A-Z0-9])/g,"$1-$2").toLowerCase();w!==a&&w1(a,t[w])})},w1=function(t,w){var a=f1(),o=a.get(t);o===void 0?a.set(t,w):o!==w&&console.warn('[Ionicons Warning]: Multiple icons were mapped to name "'.concat(t,'". Ensure that multiple icons are not mapped to the same icon name.'))};var d1="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='48' d='M244 400L100 256l144-144M120 256h292' class='ionicon-fill-none'/></svg>";var p1="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M448 256c0-106-86-192-192-192S64 150 64 256s86 192 192 192 192-86 192-192z' stroke-miterlimit='10' class='ionicon-fill-none ionicon-stroke-width'/><circle cx='256' cy='256' r='144'/></svg>";var x1="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M392 432H120a40 40 0 01-40-40V120a40 40 0 0140-40h272a40 40 0 0140 40v272a40 40 0 01-40 40z'/></svg>";var P=function(t){return t.Dark="DARK",t.Light="LIGHT",t.Default="DEFAULT",t}(P||{}),E=function(t){return t.None="NONE",t.Slide="SLIDE",t.Fade="FADE",t}(E||{});var U=h1("StatusBar");var b={production:!0,apiBaseUrl:"https://smartgatekeeper-admin.vercel.app/api",vDetectURL:"https://82bb56d051cc.ngrok-free.app"};var M1=(()=>{class t{constructor(a){this.http=a,this.baseUrl=b.apiBaseUrl}sendFrame(a,o){let s=new FormData;s.append("frame",a,"frame.jpg");let i=new K().set("stream_id",o);return this.http.post(`${this.baseUrl}/detect`,s,{params:i})}sendPreviewFrame(a,o){let s=new FormData;return s.append("frame",a,"stream.jpg"),s.append("stream_id",o),this.http.post(`${this.baseUrl}/stream-frame`,s)}static{this.\u0275fac=function(o){return new(o||t)(j(k))}}static{this.\u0275prov=S({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();var z1=(()=>{class t{constructor(a){this.http=a,this.baseUrl=b.vDetectURL}sendVehicleFrame(a){let o=new FormData;return o.append("file",a,"frame.jpg"),this.http.post(`${this.baseUrl}/detect`,o)}static{this.\u0275fac=function(o){return new(o||t)(j(k))}}static{this.\u0275prov=S({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();var H1=["video"],V1=["overlayCanvas"],C1=["captureCanvas"],A1=["streamCanvas"];function y1(t,w){t&1&&(u(0,"div",19)(1,"div",20)(2,"div",21),z(3,"Preparing camera\u2026"),x(),B(4,"ion-spinner",22),x()())}function S1(t,w){if(t&1&&(u(0,"div",14),z(1),x()),t&2){let a=D();p(),F(" Focus PID: ",a.lastFocusPid," ")}}function j1(t,w){if(t&1&&(u(0,"div",14),z(1),x()),t&2){let a=D();p(),F(" Detections: ",a.lastDetCount," ")}}var e2=(()=>{class t{constructor(a,o,s){this.detectService=a,this.http=o,this.vehicleDetectService=s,this.isStreaming=!1,this.stream=null,this.intervalId=null,this.vehicleIntervalId=null,this.streamId="mobile-1",this.statusMessage="Camera not started",this.lastFocusPid=null,this.lastDetCount=null,this.isCameraReady=!1,this.captureIntervalMs=1e3,this.detectEveryNthFrame=2,this.frameCounter=0,this.requestInFlight=!1,this.vehicleRequestInFlight=!1,this.lastPlateRes=null,this.lastVehicleRes=null,this.syncOverlaySizeBound=()=>this.syncOverlaySize(),R({arrowBack:d1,radioButtonOn:p1,stop:x1})}ngOnInit(){}ngAfterViewInit(){return y(this,null,function*(){yield this.initCamera(),this.syncOverlaySize(),window.addEventListener("resize",this.syncOverlaySizeBound)})}ngOnDestroy(){this.stopStreaming(),this.stopCamera(),window.removeEventListener("resize",this.syncOverlaySizeBound)}ionViewDidEnter(){return y(this,null,function*(){g1.getPlatform()!=="web"&&(yield U.show({animation:E.Fade}),yield U.setStyle({style:P.Dark}))})}initCamera(){return y(this,null,function*(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){this.statusMessage="Camera API not supported";return}this.isCameraReady=!1;let a=null,o={video:{facingMode:{exact:"environment"},width:{ideal:1920},height:{ideal:1080}},audio:!1},s={video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}},audio:!1};try{a=yield navigator.mediaDevices.getUserMedia(o)}catch(n){console.warn("Strict environment constraints failed, using fallback.",n),a=yield navigator.mediaDevices.getUserMedia(s)}this.stream=a;let i=this.videoRef.nativeElement;i.srcObject=this.stream,i.onloadeddata=()=>{this.isCameraReady=!0,this.syncOverlaySize()},yield i.play();let r=this.stream.getVideoTracks()[0],e=r.getCapabilities?r.getCapabilities():void 0;if(e&&(e.width||e.height)){let n=e.width&&typeof e.width.max=="number"?Math.min(1920,e.width.max):1920,v=e.height&&typeof e.height.max=="number"?Math.min(1080,e.height.max):1080;try{yield r.applyConstraints({width:n,height:v}),console.log("Applied high-res constraints:",n,v)}catch(c){console.warn("applyConstraints failed, using default stream resolution.",c)}}this.statusMessage="Tap the button to start."}catch(a){this.statusMessage="Error accessing camera: "+(a?.message||a)}})}stopCamera(){this.stream&&(this.stream.getTracks().forEach(a=>a.stop()),this.stream=null)}toggleStreaming(){this.lastDetCount=0,this.lastFocusPid=null,this.isStreaming?this.stopStreaming():this.startStreaming()}startStreaming(){if(!this.stream){this.statusMessage="Camera not initialized";return}this.intervalId&&clearInterval(this.intervalId),this.vehicleIntervalId&&clearInterval(this.vehicleIntervalId),this.isStreaming=!0,this.statusMessage="Streaming frames to server\u2026",this.frameCounter=0,this.intervalId=setInterval(()=>{this.captureAndSendFrame()},this.captureIntervalMs),this.vehicleIntervalId=setInterval(()=>{this.captureAndSendVehicleFrame()},100)}stopStreaming(){this.isStreaming=!1,this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.vehicleIntervalId&&(clearInterval(this.vehicleIntervalId),this.vehicleIntervalId=null),this.statusMessage="Streaming stopped.",this.clearOverlay()}captureAndSendFrame(){if(!this.isStreaming)return;let a=this.videoRef?.nativeElement,o=this.captureCanvasRef?.nativeElement,s=this.streamCanvasRef?.nativeElement,i=this.overlayCanvasRef?.nativeElement;if(!a||!o||!s||a.readyState<HTMLMediaElement.HAVE_ENOUGH_DATA)return;let r=a.videoWidth,e=a.videoHeight;if(!r||!e)return;let n=640,v=n/r,c=Math.round(e*v);o.width=n,o.height=c;let l=o.getContext("2d");if(!l)return;l.drawImage(a,0,0,n,c),s.width=n,s.height=c;let d=s.getContext("2d");if(!d)return;d.drawImage(a,0,0,n,c),i&&d.drawImage(i,0,0,n,c),s.toBlob(h=>{!h||!this.isStreaming||this.detectService.sendPreviewFrame(h,this.streamId).subscribe({next:g=>{},error:g=>{}})},"image/jpeg",.7),this.frameCounter%this.detectEveryNthFrame===0&&o.toBlob(h=>{!h||!this.isStreaming||this.requestInFlight||(this.requestInFlight=!0,this.detectService.sendFrame(h,this.streamId).subscribe({next:g=>{this.requestInFlight=!1,this.lastPlateRes=g,this.lastFocusPid=g.data?.focus_plate??null,this.lastDetCount=g.data?.detections?.length??0,this.statusMessage=`Streaming\u2026 detections: ${this.lastDetCount}`,this.redrawOverlay()},error:g=>{this.requestInFlight=!1,this.statusMessage="Error sending frame: "+(g?.message||g.statusText||g)}}))},"image/jpeg",.7),this.frameCounter++}captureAndSendVehicleFrame(){if(!this.isStreaming||this.vehicleRequestInFlight)return;let a=this.videoRef?.nativeElement,o=this.captureCanvasRef?.nativeElement;if(!a||!o||a.readyState<HTMLMediaElement.HAVE_ENOUGH_DATA)return;let s=a.videoWidth,i=a.videoHeight;if(!s||!i)return;let r=640,e=r/s,n=Math.round(i*e);o.width=r,o.height=n;let v=o.getContext("2d");v&&(v.drawImage(a,0,0,r,n),o.toBlob(c=>{!c||!this.isStreaming||(this.vehicleRequestInFlight=!0,this.vehicleDetectService.sendVehicleFrame(c).subscribe({next:l=>{this.vehicleRequestInFlight=!1,this.lastVehicleRes=l,this.redrawOverlay()},error:l=>{this.vehicleRequestInFlight=!1}}))},"image/jpeg",.7))}syncOverlaySize(){let a=this.videoRef?.nativeElement,o=this.overlayCanvasRef?.nativeElement;if(!a||!o)return;let s=a.getBoundingClientRect();o.width=s.width,o.height=s.height,this.clearOverlay()}clearOverlay(){let a=this.overlayCanvasRef?.nativeElement;if(!a)return;let o=a.getContext("2d");o&&(o.clearRect(0,0,a.width,a.height),this.lastPlateRes=null,this.lastVehicleRes=null)}redrawOverlay(){let a=this.overlayCanvasRef?.nativeElement;if(!a)return;let o=a.getContext("2d");if(!o)return;let s=a.width,i=a.height;if(o.clearRect(0,0,s,i),this.lastPlateRes){let r=this.lastPlateRes,e=r.data?.detections||[],n=r.data?.image_w||1,v=r.data?.image_h||1;e.forEach(c=>{let l=c.box,d,m,h,g;l.nx1!==void 0&&l.ny1!==void 0&&l.nx2!==void 0&&l.ny2!==void 0?(d=l.nx1*s,m=l.ny1*i,h=l.nx2*s,g=l.ny2*i):(d=l.x1/n*s,m=l.y1/v*i,h=l.x2/n*s,g=l.y2/v*i);let C=h-d,A=g-m;o.lineWidth=3,o.strokeStyle=c.is_focus?"#00ff00":"#ffcc00",o.strokeRect(d,m,C,A);let f=c.plate_text||"Plate";o.font="14px sans-serif";let k1=o.measureText(f).width,_=4,T=d,N=Math.max(m-20,0);o.fillStyle="rgba(0, 0, 0, 0.7)",o.fillRect(T,N,k1+_*2,18),o.fillStyle="#ffffff",o.fillText(f,T+_,N+13)})}this.lastVehicleRes&&(this.lastVehicleRes.vehicles||[]).forEach(n=>{let v=n.bbox,c=v.nx*s,l=v.ny*i,d=v.nwidth*s,m=v.nheight*i;o.lineWidth=3,o.strokeStyle="#00e5ff",o.strokeRect(c,l,d,m);let h=`${n.class_name} ${(n.confidence*100).toFixed(1)}%`;o.font="14px sans-serif";let g=o.measureText(h).width,C=4,A=c,f=Math.max(l-20,0);o.fillStyle="rgba(0, 0, 0, 0.7)",o.fillRect(A,f,g+C*2,18),o.fillStyle="#ffffff",o.fillText(h,A+C,f+13)})}static{this.\u0275fac=function(o){return new(o||t)(O(M1),O(k),O(z1))}}static{this.\u0275cmp=G({type:t,selectors:[["app-stream"]],viewQuery:function(o,s){if(o&1&&(L(H1,5),L(V1,5),L(C1,5),L(A1,5)),o&2){let i;H(i=V())&&(s.videoRef=i.first),H(i=V())&&(s.overlayCanvasRef=i.first),H(i=V())&&(s.captureCanvasRef=i.first),H(i=V())&&(s.streamCanvasRef=i.first)}},decls:24,vars:7,consts:[["video",""],["overlayCanvas",""],["captureCanvas",""],["streamCanvas",""],["translucent","true",1,"camera-header"],[2,"text-align","center"],[1,"camera-content",3,"fullscreen"],[1,"camera-wrapper"],["autoplay","","playsinline","","muted",""],[1,"overlay-canvas"],["class","camera-splash",4,"ngIf"],["hidden","",1,"capture-canvas"],[1,"status-overlay","modal-safe-botom"],[1,"status-pill"],[1,"status-line"],["class","status-line",4,"ngIf"],["vertical","bottom","horizontal","center","slot","fixed",1,"capture-fab","modal-safe-botom"],[3,"click","color"],[3,"name"],[1,"camera-splash"],[1,"camera-splash-inner"],[1,"camera-splash-title"],["name","crescent"]],template:function(o,s){if(o&1){let i=$();u(0,"ion-header",4)(1,"ion-toolbar")(2,"ion-title",5),z(3,"Vehicle Stream"),x()()(),u(4,"ion-content",6)(5,"div",7),B(6,"video",8,0)(8,"canvas",9,1),q(10,y1,5,0,"div",10),x(),B(11,"canvas",11,2)(13,"canvas",11,3),u(15,"div",12)(16,"div",13)(17,"div",14),z(18),x(),q(19,S1,2,1,"div",15)(20,j1,2,1,"div",15),x()(),u(21,"ion-fab",16)(22,"ion-fab-button",17),X("click",function(){return W(i),Q(s.toggleStreaming())}),B(23,"ion-icon",18),x()()()}o&2&&(p(4),M("fullscreen",!0),p(6),M("ngIf",!s.isCameraReady),p(8),Y(s.statusMessage),p(),M("ngIf",s.isStreaming&&s.lastDetCount&&s.lastDetCount>0&&s.lastFocusPid),p(),M("ngIf",s.isStreaming&&s.lastDetCount&&s.lastDetCount>0),p(2),M("color",s.isStreaming?"danger":"light"),p(),M("name",s.isStreaming?"stop":"radio-button-on"))},dependencies:[J,Z,t1,s1,a1,c1,l1,r1,v1,i1,n1,e1,o1],styles:['@charset "UTF-8";[_nghost-%COMP%]{--ion-safe-area-top: env(safe-area-inset-top)}.camera-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]{--background: transparent;--border-color: transparent;color:#fff}.camera-content[_ngcontent-%COMP%]{--background: #000;position:relative}.camera-wrapper[_ngcontent-%COMP%]{position:relative;width:100%;height:100%;overflow:hidden}video[_ngcontent-%COMP%]{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}.overlay-canvas[_ngcontent-%COMP%]{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}.capture-canvas[_ngcontent-%COMP%]{display:none}.status-overlay[_ngcontent-%COMP%]{position:absolute;bottom:100px;z-index:10;width:100%;display:flex;align-items:center;justify-content:center}.status-pill[_ngcontent-%COMP%]{background:#0009;border-radius:999px;padding:8px 12px;color:#fff;font-size:12px;max-width:80vw;display:flex;flex-direction:column;align-items:center;justify-content:center}.status-line[_ngcontent-%COMP%]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.capture-fab[_ngcontent-%COMP%]   ion-fab-button[_ngcontent-%COMP%]{width:72px;height:72px;border-radius:50%;box-shadow:0 0 0 4px #fff6}.capture-fab[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:32px}.camera-splash[_ngcontent-%COMP%]{position:absolute;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:20}.camera-splash-inner[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:12px}.camera-splash-title[_ngcontent-%COMP%]{color:#fff;font-size:14px;opacity:.85}']})}}return t})();export{e2 as StreamPage};
