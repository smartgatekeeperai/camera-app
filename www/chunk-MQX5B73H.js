import{A as j,D as f,E as M,F as x,G as V,K as $,L as Y,M as O,Oa as i1,Pa as n1,Q as C,Qa as l1,R as A,Ra as c1,S as y,Sa as e1,T as L,Ta as r1,U as Z,Ua as v1,V as b,Za as g1,_ as J,aa as K,b as U,da as o1,e as T,ga as a1,h as N,l as W,m as Q,na as s1,sa as t1,t as p,u as G,w as X}from"./chunk-LXIEH4IW.js";import"./chunk-N6LJKXTK.js";import{a as w1,b as h1}from"./chunk-TCIP6WF6.js";import"./chunk-BNBRWPES.js";import"./chunk-ISHI2HGM.js";import"./chunk-NR7J2KNO.js";import"./chunk-O6KY7EYP.js";import"./chunk-XF2MK4EZ.js";import"./chunk-4WFVMWDK.js";import"./chunk-M2X7KQLB.js";import"./chunk-2YSZFPCQ.js";import"./chunk-57YRIO75.js";import"./chunk-FNBMHXHF.js";import"./chunk-C5RQ2IC2.js";import"./chunk-42C7ZIID.js";import{h as S}from"./chunk-B7O3QC5Z.js";var q,M1=function(){if(typeof window>"u")return new Map;if(!q){var t=window;t.Ionicons=t.Ionicons||{},q=t.Ionicons.map=t.Ionicons.map||new Map}return q},D=function(t){Object.keys(t).forEach(function(d){d1(d,t[d]);var a=d.replace(/([a-z0-9]|(?=[A-Z]))([A-Z0-9])/g,"$1-$2").toLowerCase();d!==a&&d1(a,t[d])})},d1=function(t,d){var a=M1(),o=a.get(t);o===void 0?a.set(t,d):o!==d&&console.warn('[Ionicons Warning]: Multiple icons were mapped to name "'.concat(t,'". Ensure that multiple icons are not mapped to the same icon name.'))};var p1="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='48' d='M244 400L100 256l144-144M120 256h292' class='ionicon-fill-none'/></svg>";var x1="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M448 256c0-106-86-192-192-192S64 150 64 256s86 192 192 192 192-86 192-192z' stroke-miterlimit='10' class='ionicon-fill-none ionicon-stroke-width'/><circle cx='256' cy='256' r='144'/></svg>";var m1="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' class='ionicon' viewBox='0 0 512 512'><path d='M392 432H120a40 40 0 01-40-40V120a40 40 0 0140-40h272a40 40 0 0140 40v272a40 40 0 01-40 40z'/></svg>";var F=function(t){return t.Dark="DARK",t.Light="LIGHT",t.Default="DEFAULT",t}(F||{}),I=function(t){return t.None="NONE",t.Slide="SLIDE",t.Fade="FADE",t}(I||{});var R=h1("StatusBar");var P={production:!0,apiBaseUrl:"http://192.168.254.103:8000"};var u1=(()=>{class t{constructor(a){this.http=a}sendFrame(a,o){let s=new FormData;return s.append("file",a,"frame.jpg"),this.http.post(`${P.apiBaseUrl}/detect`,s).pipe(U(i=>{let h=i?.image_width??640,e=i?.image_height??480,m=(i?.plates||[]).map(c=>{let n=c.bbox||{},g=n.x1||0,r=n.y1||0,z=n.x2||0,B=n.y2||0,u=z-g,k=B-r;return{plate_text:c.ocr?.text||"",detection_conf:1,ocr_conf:c.ocr?.confidence||0,is_focus:!0,box:{x1:g,y1:r,x2:z,y2:B,width:u,height:k,cx:g+u/2,cy:r+k/2,nx1:0,ny1:0,nx2:0,ny2:0}}}),l=(i?.vehicles||[]).map(c=>{let n=c.bbox||{};return{bbox:{x1:n.x1||0,y1:n.y1||0,x2:n.x2||0,y2:n.y2||0,width:n.width||0,height:n.height||0,cx:n.cx||0,cy:n.cy||0,nx:n.nx||0,ny:n.ny||0,nwidth:n.nwidth||0,nheight:n.nheight||0},confidence:c.confidence||0,class_id:c.class_id??-1,class_name:c.class_name||"vehicle"}});return{data:{stream_id:o,image_w:h,image_h:e,focus_plate:m.length?m[0].plate_text:null,detections:m,vehicles:l}}}))}sendPreviewFrame(a,o){let s=new FormData;return s.append("frame",a,"stream.jpg"),s.append("stream_id",o),this.http.post(`${P.apiBaseUrl}/stream-frame`,s)}static{this.\u0275fac=function(o){return new(o||t)(N(o1))}}static{this.\u0275prov=T({token:t,factory:t.\u0275fac,providedIn:"root"})}}return t})();var f1=["video"],B1=["overlayCanvas"],L1=["captureCanvas"],H1=["streamCanvas"];function V1(t,d){t&1&&(M(0,"div",19)(1,"div",20)(2,"div",21),L(3,"Preparing camera\u2026"),x(),V(4,"ion-spinner",22),x()())}function C1(t,d){if(t&1&&(M(0,"div",14),L(1),x()),t&2){let a=O();p(),b(" Focus PID: ",a.lastFocusPid," ")}}function A1(t,d){if(t&1&&(M(0,"div",14),L(1),x()),t&2){let a=O();p(),b(" Detections: ",a.lastDetCount," ")}}var i2=(()=>{class t{constructor(a){this.detectService=a,this.isStreaming=!1,this.stream=null,this.intervalId=null,this.streamId="mobile-1",this.statusMessage="Camera not started",this.lastFocusPid=null,this.lastDetCount=null,this.isCameraReady=!1,this.captureIntervalMs=1e3,this.detectEveryNthFrame=2,this.frameCounter=0,this.requestInFlight=!1,this.lastRes=null,this.syncOverlaySizeBound=()=>this.syncOverlaySize(),D({arrowBack:p1,radioButtonOn:x1,stop:m1})}ngOnInit(){}ngAfterViewInit(){return S(this,null,function*(){yield this.initCamera(),this.syncOverlaySize(),window.addEventListener("resize",this.syncOverlaySizeBound)})}ngOnDestroy(){this.stopStreaming(),this.stopCamera(),window.removeEventListener("resize",this.syncOverlaySizeBound)}ionViewDidEnter(){return S(this,null,function*(){w1.getPlatform()!=="web"&&(yield R.show({animation:I.Fade}),yield R.setStyle({style:F.Dark}))})}initCamera(){return S(this,null,function*(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){this.statusMessage="Camera API not supported";return}this.isCameraReady=!1;let a=null,o={video:{facingMode:{exact:"environment"},width:{ideal:1920},height:{ideal:1080}},audio:!1},s={video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}},audio:!1};try{a=yield navigator.mediaDevices.getUserMedia(o)}catch(w){console.warn("Strict environment constraints failed, using fallback.",w),a=yield navigator.mediaDevices.getUserMedia(s)}this.stream=a;let i=this.videoRef.nativeElement;i.srcObject=this.stream,i.onloadeddata=()=>{this.isCameraReady=!0,this.syncOverlaySize()},yield i.play();let h=this.stream.getVideoTracks()[0],e=h.getCapabilities?h.getCapabilities():void 0;if(e&&(e.width||e.height)){let w=e.width&&typeof e.width.max=="number"?Math.min(1920,e.width.max):1920,m=e.height&&typeof e.height.max=="number"?Math.min(1080,e.height.max):1080;try{yield h.applyConstraints({width:w,height:m}),console.log("Applied high-res constraints:",w,m)}catch(v){console.warn("applyConstraints failed, using default stream resolution.",v)}}this.statusMessage="Tap the button to start."}catch(a){this.statusMessage="Error accessing camera: "+(a?.message||a)}})}stopCamera(){this.stream&&(this.stream.getTracks().forEach(a=>a.stop()),this.stream=null)}toggleStreaming(){this.lastDetCount=0,this.lastFocusPid=null,this.isStreaming?this.stopStreaming():this.startStreaming()}startStreaming(){if(!this.stream){this.statusMessage="Camera not initialized";return}this.intervalId&&clearInterval(this.intervalId),this.isStreaming=!0,this.statusMessage="Streaming frames to server\u2026",this.frameCounter=0,this.intervalId=setInterval(()=>{this.captureAndSendFrame()},this.captureIntervalMs)}stopStreaming(){this.isStreaming=!1,this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.statusMessage="Streaming stopped.",this.clearOverlay()}captureAndSendFrame(){if(!this.isStreaming)return;let a=this.videoRef?.nativeElement,o=this.captureCanvasRef?.nativeElement,s=this.streamCanvasRef?.nativeElement,i=this.overlayCanvasRef?.nativeElement;if(!a||!o||!s||a.readyState<HTMLMediaElement.HAVE_ENOUGH_DATA)return;let h=a.videoWidth,e=a.videoHeight;if(!h||!e)return;let w=640,m=w/h,v=Math.round(e*m);o.width=w,o.height=v;let l=o.getContext("2d");if(!l)return;l.drawImage(a,0,0,w,v),s.width=w,s.height=v;let c=s.getContext("2d");if(!c)return;c.drawImage(a,0,0,w,v),i&&c.drawImage(i,0,0,w,v),s.toBlob(g=>{!g||!this.isStreaming||this.detectService.sendPreviewFrame(g,this.streamId).subscribe({next:()=>{},error:()=>{}})},"image/jpeg",.7),this.frameCounter%this.detectEveryNthFrame===0&&o.toBlob(g=>{!g||!this.isStreaming||this.requestInFlight||(this.requestInFlight=!0,this.detectService.sendFrame(g,this.streamId).subscribe({next:r=>{this.requestInFlight=!1,this.lastRes=r,this.lastFocusPid=r.data?.focus_plate??null,this.lastDetCount=r.data?.detections?.length??0,this.statusMessage=`Streaming\u2026 detections: ${this.lastDetCount}`,this.redrawOverlay()},error:r=>{this.requestInFlight=!1,this.statusMessage="Error sending frame: "+(r?.message||r.statusText||r)}}))},"image/jpeg",.7),this.frameCounter++}syncOverlaySize(){let a=this.videoRef?.nativeElement,o=this.overlayCanvasRef?.nativeElement;if(!a||!o)return;let s=a.getBoundingClientRect();o.width=s.width,o.height=s.height,this.clearOverlay()}clearOverlay(){let a=this.overlayCanvasRef?.nativeElement;if(!a)return;let o=a.getContext("2d");o&&(o.clearRect(0,0,a.width,a.height),this.lastRes=null)}redrawOverlay(){if(!this.lastRes)return;let a=this.overlayCanvasRef?.nativeElement;if(!a)return;let o=a.getContext("2d");if(!o)return;let s=a.width,i=a.height,h=this.lastRes.data?.image_w||1,e=this.lastRes.data?.image_h||1;o.clearRect(0,0,s,i),(this.lastRes.data?.detections||[]).forEach(v=>{let l=v.box,c,n,g,r;l.nx1!==void 0&&l.ny1!==void 0&&l.nx2!==void 0&&l.ny2!==void 0&&(l.nx1!==0||l.ny1!==0||l.nx2!==0||l.ny2!==0)?(c=l.nx1*s,n=l.ny1*i,g=l.nx2*s,r=l.ny2*i):(c=l.x1/h*s,n=l.y1/e*i,g=l.x2/h*s,r=l.y2/e*i);let z=g-c,B=r-n;o.lineWidth=3,o.strokeStyle=v.is_focus?"#00ff00":"#ffcc00",o.strokeRect(c,n,z,B);let u=v.plate_text||"Plate";o.font="14px sans-serif";let k=o.measureText(u).width,H=4,_=c,E=Math.max(n-20,0);o.fillStyle="rgba(0, 0, 0, 0.7)",o.fillRect(_,E,k+H*2,18),o.fillStyle="#ffffff",o.fillText(u,_+H,E+13)}),(this.lastRes.data?.vehicles||[]).forEach(v=>{let l=v.bbox,c=l.nx*s,n=l.ny*i,g=l.nwidth*s,r=l.nheight*i;o.lineWidth=3,o.strokeStyle="#00e5ff",o.strokeRect(c,n,g,r);let z=`${v.class_name} ${(v.confidence*100).toFixed(1)}%`;o.font="14px sans-serif";let B=o.measureText(z).width,u=4,k=c,H=Math.max(n-20,0);o.fillStyle="rgba(0, 0, 0, 0.7)",o.fillRect(k,H,B+u*2,18),o.fillStyle="#ffffff",o.fillText(z,k+u,H+13)})}static{this.\u0275fac=function(o){return new(o||t)(G(u1))}}static{this.\u0275cmp=X({type:t,selectors:[["app-stream"]],viewQuery:function(o,s){if(o&1&&(C(f1,5),C(B1,5),C(L1,5),C(H1,5)),o&2){let i;A(i=y())&&(s.videoRef=i.first),A(i=y())&&(s.overlayCanvasRef=i.first),A(i=y())&&(s.captureCanvasRef=i.first),A(i=y())&&(s.streamCanvasRef=i.first)}},decls:24,vars:7,consts:[["video",""],["overlayCanvas",""],["captureCanvas",""],["streamCanvas",""],["translucent","true",1,"camera-header"],[2,"text-align","center"],[1,"camera-content",3,"fullscreen"],[1,"camera-wrapper"],["autoplay","","playsinline","","muted",""],[1,"overlay-canvas"],["class","camera-splash",4,"ngIf"],["hidden","",1,"capture-canvas"],[1,"status-overlay","modal-safe-botom"],[1,"status-pill"],[1,"status-line"],["class","status-line",4,"ngIf"],["vertical","bottom","horizontal","center","slot","fixed",1,"capture-fab","modal-safe-botom"],[3,"click","color"],[3,"name"],[1,"camera-splash"],[1,"camera-splash-inner"],[1,"camera-splash-title"],["name","crescent"]],template:function(o,s){if(o&1){let i=$();M(0,"ion-header",4)(1,"ion-toolbar")(2,"ion-title",5),L(3,"Vehicle Stream"),x()()(),M(4,"ion-content",6)(5,"div",7),V(6,"video",8,0)(8,"canvas",9,1),j(10,V1,5,0,"div",10),x(),V(11,"canvas",11,2)(13,"canvas",11,3),M(15,"div",12)(16,"div",13)(17,"div",14),L(18),x(),j(19,C1,2,1,"div",15)(20,A1,2,1,"div",15),x()(),M(21,"ion-fab",16)(22,"ion-fab-button",17),Y("click",function(){return W(i),Q(s.toggleStreaming())}),V(23,"ion-icon",18),x()()()}o&2&&(p(4),f("fullscreen",!0),p(6),f("ngIf",!s.isCameraReady),p(8),Z(s.statusMessage),p(),f("ngIf",s.isStreaming&&s.lastDetCount&&s.lastDetCount>0&&s.lastFocusPid),p(),f("ngIf",s.isStreaming&&s.lastDetCount&&s.lastDetCount>0),p(2),f("color",s.isStreaming?"danger":"light"),p(),f("name",s.isStreaming?"stop":"radio-button-on"))},dependencies:[K,J,i1,t1,s1,r1,c1,v1,g1,n1,l1,e1,a1],styles:['@charset "UTF-8";[_nghost-%COMP%]{--ion-safe-area-top: env(safe-area-inset-top)}.camera-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]{--background: transparent;--border-color: transparent;color:#fff}.camera-content[_ngcontent-%COMP%]{--background: #000;position:relative}.camera-wrapper[_ngcontent-%COMP%]{position:relative;width:100%;height:100%;overflow:hidden}video[_ngcontent-%COMP%]{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}.overlay-canvas[_ngcontent-%COMP%]{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}.capture-canvas[_ngcontent-%COMP%]{display:none}.status-overlay[_ngcontent-%COMP%]{position:absolute;bottom:100px;z-index:10;width:100%;display:flex;align-items:center;justify-content:center}.status-pill[_ngcontent-%COMP%]{background:#0009;border-radius:999px;padding:8px 12px;color:#fff;font-size:12px;max-width:80vw;display:flex;flex-direction:column;align-items:center;justify-content:center}.status-line[_ngcontent-%COMP%]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.capture-fab[_ngcontent-%COMP%]   ion-fab-button[_ngcontent-%COMP%]{width:72px;height:72px;border-radius:50%;box-shadow:0 0 0 4px #fff6}.capture-fab[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:32px}.camera-splash[_ngcontent-%COMP%]{position:absolute;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:20}.camera-splash-inner[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:12px}.camera-splash-title[_ngcontent-%COMP%]{color:#fff;font-size:14px;opacity:.85}']})}}return t})();export{i2 as StreamPage};
